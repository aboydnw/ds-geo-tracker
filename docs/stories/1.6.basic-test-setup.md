# Story 1.6: Basic Test Setup

## Status
Draft

## Story
**As a** developer,
**I want** automated tests for core modules,
**so that** I can catch regressions and validate behavior without manual testing.

## Acceptance Criteria
1. Uses Node.js 20+ built-in test runner (`node --test`) — no test framework dependency needed
2. `src/plausible.test.js` tests the `sendEventToPlausible` function with a mocked `fetch`
3. `src/queries.test.js` validates query array structure (all required fields present, no duplicate IDs)
4. Tests can be run via `npm test`
5. Tests pass in CI (GitHub Actions workflow runs tests before the tracking script)

## Tasks / Subtasks
- [ ] Verify `package.json` has test script (AC: 4)
  - [ ] `"test": "node --test src/**/*.test.js"`
- [ ] Create `src/plausible.test.js` (AC: 1, 2)
  - [ ] Import `sendEventToPlausible` from plausible.js
  - [ ] Mock global `fetch` to capture calls without hitting the network
  - [ ] Test: returns `true` when fetch returns 202
  - [ ] Test: returns `false` when fetch returns 500
  - [ ] Test: returns `false` when PLAUSIBLE_DOMAIN is not set
  - [ ] Test: payload includes correct name, url, domain, props
  - [ ] Restore original `fetch` after each test
- [ ] Create `src/queries.test.js` (AC: 1, 3)
  - [ ] Import GEO_QUERIES from queries.js
  - [ ] Test: queries is a non-empty array
  - [ ] Test: each query has `id`, `name`, `searchTerms`, `category`
  - [ ] Test: no duplicate `id` values
  - [ ] Test: `searchTerms` is an array with at least one entry per query
  - [ ] Test: `category` is one of the expected values
- [ ] Update GitHub Actions workflow (AC: 5)
  - [ ] Add `npm test` step before `node index.js`
  - [ ] Tests must pass for the workflow to continue

## Dev Notes
**Node.js Built-in Test Runner:**
Node.js 20+ includes a built-in test runner (`node:test` module) that eliminates the need for Jest, Mocha, or other test frameworks.

```javascript
// Example test file using built-in test runner
import { describe, it, mock, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert/strict';
import { sendEventToPlausible } from './plausible.js';

describe('sendEventToPlausible', () => {
  let originalFetch;

  beforeEach(() => {
    originalFetch = global.fetch;
    process.env.PLAUSIBLE_DOMAIN = 'test.example.com';
  });

  afterEach(() => {
    global.fetch = originalFetch;
  });

  it('should return true on HTTP 202', async () => {
    global.fetch = mock.fn(() =>
      Promise.resolve({ status: 202, ok: true })
    );

    const result = await sendEventToPlausible('test_event', { key: 'value' });
    assert.equal(result, true);
  });

  it('should return false when PLAUSIBLE_DOMAIN is not set', async () => {
    delete process.env.PLAUSIBLE_DOMAIN;
    const result = await sendEventToPlausible('test_event', {});
    assert.equal(result, false);
  });
});
```

**queries.test.js example:**
```javascript
import { describe, it } from 'node:test';
import assert from 'node:assert/strict';
import GEO_QUERIES from './queries.js';

describe('GEO_QUERIES', () => {
  it('should be a non-empty array', () => {
    assert.ok(Array.isArray(GEO_QUERIES));
    assert.ok(GEO_QUERIES.length > 0);
  });

  it('should have no duplicate IDs', () => {
    const ids = GEO_QUERIES.map(q => q.id);
    const uniqueIds = new Set(ids);
    assert.equal(ids.length, uniqueIds.size);
  });

  it('should have all required fields', () => {
    for (const query of GEO_QUERIES) {
      assert.ok(typeof query.id === 'string');
      assert.ok(typeof query.name === 'string');
      assert.ok(Array.isArray(query.searchTerms));
      assert.ok(query.searchTerms.length > 0);
      assert.ok(typeof query.category === 'string');
    }
  });
});
```

**Updated GitHub Actions workflow step:**
```yaml
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-node@v4
    with:
      node-version: '20'
  - run: npm ci
  - run: npm test         # Run tests first
  - run: node index.js    # Only runs if tests pass
    env:
      PLAUSIBLE_DOMAIN: ${{ secrets.PLAUSIBLE_DOMAIN }}
```

**File Locations:**
- `src/plausible.test.js`
- `src/queries.test.js`

### Testing
- Run `npm test` locally — all tests should pass
- Run with `--test-reporter spec` for verbose output
- Verify tests catch intentional breakage (e.g., remove a required field from a query)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story created | Reviewer |
