# Story 1.4: Main Tracking Script

## Status
Ready for Review

## Story
**As a** developer,  
**I want** a main script that processes all queries and sends events,  
**so that** the tracker can run as a scheduled job.

## Acceptance Criteria
1. `index.js` loads environment variables via dotenv at startup
2. Script iterates through all GEO queries and sends events to Plausible
3. Each event includes: `query_id`, `query_name`, `category`, `timestamp` in props
4. Script logs start time, progress for each query, and completion summary
5. Script exits with code 0 on success, code 1 on critical failure
6. 500ms delay between API calls to avoid rate limiting
7. Script can be run manually via `node index.js`

## Tasks / Subtasks
- [x] Update `index.js` to import dependencies (AC: 1)
  - [x] Import and configure dotenv
  - [x] Import `sendEventToPlausible` from plausible.js
  - [x] Import `queries` from queries.js
- [x] Implement main `trackGEOQueries` async function (AC: 2, 3)
  - [x] Log job start time with ISO timestamp
  - [x] Loop through all queries
  - [x] Call `sendEventToPlausible` for each query
  - [x] Include query_id, query_name, category, timestamp in props
- [x] Add progress logging (AC: 4)
  - [x] Log "Processing query X/Y: {name}" for each query
  - [x] Log success/failure for each event
  - [x] Log summary: total, successful, failed counts
- [x] Implement exit codes (AC: 5)
  - [x] Exit 0 if all or most events succeed
  - [x] Exit 1 if critical error (e.g., no queries, config invalid)
- [x] Add rate limiting delay (AC: 6)
  - [x] 500ms `setTimeout` between API calls
  - [x] Use `await` with Promise wrapper
- [x] Ensure script is directly executable (AC: 7)
  - [x] Call `trackGEOQueries()` at module level
  - [x] Handle async execution properly

## Dev Notes
**Script Flow:**
```
1. Load .env configuration
2. Log startup banner
3. Validate configuration (basic check)
4. For each query:
   a. Log "Processing..."
   b. Send event to Plausible
   c. Log result
   d. Wait 500ms
5. Log summary (X/Y succeeded)
6. Exit with appropriate code
```

**Event Name:**  
Use `GEO_Query_Tracked` as the event name for all queries.

**Timestamp:**  
Use ISO 8601 format: `new Date().toISOString()`

**Exit Codes:**
- `0` - Success (all or most events sent)
- `1` - Failure (critical error, config invalid, or >50% events failed)

**File Location:** `index.js` (root directory)

### Testing
- Create `.env` with `PLAUSIBLE_DOMAIN=developmentseed.org`
- Run `node index.js`
- Verify logs show progress for each query
- Verify summary shows counts
- Verify exit code is 0 on success
- Check Plausible dashboard for events (may take a few minutes)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story created | PO Agent |
| 2026-02-06 | 0.2 | Implementation complete | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (Cursor IDE)

### Debug Log References
None - clean implementation.

### Completion Notes
- Rewrote `index.js` with full tracking functionality
- All 7 queries processed and sent to Plausible successfully
- Events include: query_id, query_name, category, search_terms, timestamp
- 500ms delay between API calls implemented
- Duration: ~4.4s for 7 queries (includes rate limiting delays)
- Exit code 0 confirmed on success
- Script validates PLAUSIBLE_DOMAIN and query count on startup

### File List
| Action | File |
|--------|------|
| Modified | `index.js` (complete rewrite with tracking logic) |
