# Story 3.5: GitHub Actions Workflow Updates for Multi-LLM Tracking

## Status
Draft

## Story
**As a** developer,
**I want** the GitHub Actions workflow updated to support the longer runtime and additional secrets required by multi-LLM tracking,
**so that** the daily tracker runs reliably with all configured LLM sources.

## Context
The current workflow (`.github/workflows/geo-tracker.yml`) has a 2-minute timeout and only passes `PLAUSIBLE_DOMAIN` as a secret. With Epic 3's multi-LLM queries, the runtime will increase significantly: 7 queries × up to 4 LLMs × 1-second rate limits + API latency = 1-3 minutes typical, with potential for longer runs if APIs are slow. The workflow also needs to pass API keys for each LLM source.

## Acceptance Criteria
1. Workflow timeout increased to 5 minutes
2. All LLM API key secrets passed as environment variables to the tracker step
3. Secrets are optional — the tracker handles missing keys gracefully (Story 3.2/3.3 AC), so the workflow should not fail if a secret is not configured
4. `PLAUSIBLE_DOMAIN` updated to reflect the new dedicated tracker site
5. Workflow includes a test step that runs before the tracker

## Tasks / Subtasks
- [ ] Update workflow timeout (AC: 1)
  - [ ] Change `timeout-minutes: 2` to `timeout-minutes: 5`
- [ ] Add LLM API key secrets (AC: 2, 3)
  - [ ] Add `PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}`
  - [ ] Add `OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}`
  - [ ] Add `ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}`
  - [ ] Add `GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}`
  - [ ] All use `${{ secrets.* }}` which resolve to empty string if not configured — this is fine, sources check for presence
- [ ] Update Plausible domain secret (AC: 4)
  - [ ] Document that `PLAUSIBLE_DOMAIN` should now be set to the dedicated tracker site (e.g., `geo.developmentseed.org`)
- [ ] Add test step (AC: 5)
  - [ ] Add `run: npm test` step before `run: node index.js`
  - [ ] Tests run without any API keys (all unit tests use mocks)

## Dev Notes

### Updated Workflow
```yaml
name: GEO Tracker
on:
  schedule:
    - cron: '0 9 * * *'    # Daily at 9:00 AM UTC
  workflow_dispatch:         # Manual trigger support

jobs:
  track:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm test
      - run: node index.js
        env:
          PLAUSIBLE_DOMAIN: ${{ secrets.PLAUSIBLE_DOMAIN }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
```

### Why 5 Minutes (Not Split Into Multiple Workflows)
Splitting into separate workflows per LLM would add complexity (multiple workflow files, separate schedules, harder to get a unified summary) without meaningful benefit. The primary concern was the 2-minute timeout being too tight. At 5 minutes there's ample headroom for 4 LLMs × 7 queries even with slow API responses. If we ever add significantly more queries or sources, we can revisit splitting then.

A single workflow also means the summary output (Story 3.4) covers all sources in one log, making it easier to monitor.

### Secrets Configuration
After this story ships, the repo admin needs to add these GitHub Secrets:
- `PLAUSIBLE_DOMAIN` — update to `geo.developmentseed.org` (or chosen tracker domain)
- `PERPLEXITY_API_KEY` — from https://www.perplexity.ai/settings/api
- `OPENAI_API_KEY` — from https://platform.openai.com/api-keys
- `ANTHROPIC_API_KEY` — from https://console.anthropic.com/settings/keys
- `GOOGLE_AI_API_KEY` — from https://aistudio.google.com/apikey

Only `PLAUSIBLE_DOMAIN` is strictly required. LLM keys are additive — add them as you enable each source.

### Testing
- Trigger workflow manually with only `PLAUSIBLE_DOMAIN` set → runs but skips all LLM sources (graceful, exit 0)
- Trigger with one LLM key added → that source runs, others skipped
- Verify `npm test` step runs and passes before tracker executes
- Verify workflow completes within 5-minute timeout under normal conditions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1 | Story created for GitHub Actions workflow updates | Review |
