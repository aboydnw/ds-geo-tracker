# Story 1.3: Plausible Analytics Integration

## Status
Ready for Review

## Story
**As a** developer,
**I want** a module that sends custom events to Plausible,
**so that** tracking data appears in our analytics dashboard.

## Acceptance Criteria
1. `src/plausible.js` exports `sendEventToPlausible(eventName, props)` async function
2. Function sends POST request to `https://plausible.io/api/event` using native `fetch` (Node.js 20+)
3. Payload includes: `name`, `url`, `domain`, `props` fields
4. Function returns `true` on success (HTTP 202), `false` on failure
5. Errors are caught and logged, not thrown (graceful failure)
6. Domain is read from `PLAUSIBLE_DOMAIN` environment variable
7. Function validates that required env vars exist before sending

## Tasks / Subtasks
- [x] Create `src/plausible.js` file (AC: 1)
- [x] Implement `sendEventToPlausible` function using native `fetch` (AC: 1, 2)
  - [x] Build payload object with name, url, domain, props
  - [x] Set Content-Type header to application/json
  - [x] Set User-Agent header to identify the tracker
  - [x] Send POST request to Plausible API endpoint
- [x] Handle response status codes (AC: 4)
  - [x] Return `true` for HTTP 202 (Accepted)
  - [x] Return `false` for other status codes
- [x] Implement error handling (AC: 5)
  - [x] Wrap fetch in try/catch
  - [x] Log error message but don't throw
  - [x] Return `false` on any error
- [x] Read domain from environment (AC: 6)
  - [x] Access `process.env.PLAUSIBLE_DOMAIN`
  - [x] Construct URL as `https://${domain}/`
- [x] Add environment validation (AC: 7)
  - [x] Check PLAUSIBLE_DOMAIN exists before sending
  - [x] Log warning if missing
  - [x] Return `false` if config invalid

## Dev Notes
**Plausible Events API:**
- Endpoint: `https://plausible.io/api/event`
- Method: POST
- Success Response: HTTP 202 (Accepted)
- No authentication required for event ingestion (no API key needed)
- Rate limited by domain
- Self-hosted Plausible instances may have different authentication requirements

**HTTP Client:**
Uses the native `fetch` API built into Node.js 20+. No external HTTP library needed.

**Payload Structure:**
```javascript
{
  name: 'GEO_Query_Tracked',        // Event name
  url: 'https://developmentseed.org/', // Page URL
  domain: 'developmentseed.org',    // Site domain
  props: {                          // Custom properties
    query_id: 'veda-dashboard',
    query_name: 'VEDA Dashboard',
    category: 'product',
    timestamp: '2026-02-05T09:00:00Z'
  }
}
```

**Environment Variables:**
- `PLAUSIBLE_DOMAIN` - Required, the domain registered in Plausible (e.g., `developmentseed.org`)

**File Location:** `src/plausible.js`

### Testing
- Set `PLAUSIBLE_DOMAIN=developmentseed.org` in `.env`
- Call function with test event
- Verify HTTP 202 response (check Plausible dashboard or use dry-run in future story)
- Test with missing env var - should return false and log warning

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story created | PO Agent |
| 2026-02-05 | 0.2 | Updated: native fetch instead of node-fetch, clarified no API key needed | Reviewer |
| 2026-02-05 | 0.3 | Implementation complete | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (Cursor IDE)

### Debug Log References
None - clean implementation.

### Completion Notes
- Created `src/plausible.js` with `sendEventToPlausible()` function
- Uses native fetch API (Node.js 18+, stable in 20+)
- Added graceful fallback: logs warning if fetch unavailable (older Node.js versions)
- Validates PLAUSIBLE_DOMAIN before sending
- Returns boolean for success/failure, never throws
- Local Node.js is v16 (no native fetch), but GitHub Actions uses Node.js 20 where it will work
- Full API testing will occur in Story 1.4 when integrated with main script

### File List
| Action | File |
|--------|------|
| Created | `src/plausible.js` |
