# Story 2.3: Slack Failure Notifications

## Status
Draft

## Story
**As an** operations team member,
**I want** Slack notifications when the tracking job fails,
**so that** I'm alerted to issues without checking GitHub Actions manually.

## Acceptance Criteria
1. `src/slack.js` exports `sendSlackNotification(message, isError)` async function
2. Function sends POST to `SLACK_WEBHOOK_URL` if configured
3. If `SLACK_WEBHOOK_URL` is not set, function silently skips (graceful degradation)
4. Message includes: job status, error details (if any), timestamp, link to GitHub run
5. Main script sends notification on failure (any unhandled error or critical failure)
6. Notifications use appropriate emoji: checkmark for success, X for failure

## Tasks / Subtasks
- [ ] Create `src/slack.js` file (AC: 1)
- [ ] Implement `sendSlackNotification` function (AC: 1, 2)
  - [ ] Accept `message` string and `isError` boolean parameters
  - [ ] Build Slack webhook payload
  - [ ] Send POST request to webhook URL using native `fetch`
- [ ] Add graceful degradation (AC: 3)
  - [ ] Check if SLACK_WEBHOOK_URL exists
  - [ ] If not set, log debug message and return early
  - [ ] Don't throw errors for missing webhook
- [ ] Build notification message (AC: 4)
  - [ ] Include job status (success/failure)
  - [ ] Include error details if isError is true
  - [ ] Include ISO timestamp
  - [ ] Include GitHub Actions run URL from env vars
- [ ] Update main script error handling (AC: 5)
  - [ ] Import `sendSlackNotification`
  - [ ] Call on critical failure before exit
  - [ ] Wrap main execution in try/catch
- [ ] Use appropriate formatting (AC: 6)
  - [ ] Success: green checkmark emoji
  - [ ] Failure: red X emoji

## Dev Notes
**Slack Module Location:** `src/slack.js`

**Alternative approaches considered:**
Before implementing a custom Slack client, consider whether these simpler alternatives would suffice:
- **GitHub Actions built-in notifications** — GitHub can send email notifications on workflow failure (Settings > Notifications). This requires zero code.
- **GitHub Actions Slack action** — The `slackapi/slack-github-action` marketplace action can send Slack messages as a workflow step, avoiding custom code entirely. Add a step after the tracking job that runs `if: failure()`.

The custom `src/slack.js` approach is preferred if you need: richer message formatting, per-query failure detail in the Slack message, or notifications from within the script (not just workflow-level pass/fail).

**Slack Webhook Payload:**
```javascript
{
  text: "GEO Tracker: Job failed",
  blocks: [
    {
      type: "section",
      text: {
        type: "mrkdwn",
        text: ":x: *GEO Tracker Failed*\n\nError: Configuration validation failed\nTime: 2026-02-05T09:00:00Z"
      }
    },
    {
      type: "context",
      elements: [
        {
          type: "mrkdwn",
          text: "<https://github.com/org/repo/actions/runs/123|View GitHub Actions Run>"
        }
      ]
    }
  ]
}
```

**GitHub Actions Environment Variables:**
- `GITHUB_SERVER_URL` - e.g., https://github.com
- `GITHUB_REPOSITORY` - e.g., developmentseed/geo-tracking
- `GITHUB_RUN_ID` - e.g., 12345678

**Webhook URL:**
Create at: https://api.slack.com/messaging/webhooks

**Environment Variable:**
- `SLACK_WEBHOOK_URL` - Optional, Slack incoming webhook URL

### Testing
- Test without SLACK_WEBHOOK_URL set -> should run without errors
- Test with invalid URL -> should log error but not crash
- Test with valid webhook -> should receive Slack message
- Trigger failure (e.g., invalid PLAUSIBLE_DOMAIN) -> should send failure notification

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 0.1 | Initial story created | PO Agent |
| 2026-02-05 | 0.2 | Added alternative approaches note (GH Actions notifications, Slack action) | Reviewer |
